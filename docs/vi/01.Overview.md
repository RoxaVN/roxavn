## MÃ´ hÃ¬nh tá»•ng quan

RoxaVN lÃ  framework **fullstack**, lo luÃ´n cáº£ backend láº«n frontend. NÃ³i cÃ¡ch khÃ¡c, â€œtrá»n gÃ³i tá»« A Ä‘áº¿n Zâ€.

```mermaid
---
config:
  theme: neutral
---
flowchart LR
  subgraph L1["Users Layer"]
    provider["ğŸ¢ Provider"]
    consumer["ğŸ¤µ Consumer"]
  end
  subgraph L2["Web application"]
    adminDashboard["ğŸ“Š Admin Dashboard"]
    personalProfile["ğŸªª Personal Profile"]
    customApplication["ğŸ§© Custom Application"]
  end
  subgraph L3["Backend"]
    webServer["ğŸ’» Web Server"]
    jobService["ğŸ” Job Service"]
  end
  subgraph L4["Database"]
    postgres["ğŸ˜ Postgres"]
    redis["âš¡ Redis"]
  end

  provider -- manage data --> adminDashboard
  consumer -- update info --> personalProfile
  L2 ==> L3
  L3 ==> L4
```

### 1. Lá»›p ngÆ°á»i dÃ¹ng
- **NhÃ  cung cáº¥p:** tá»• chá»©c hoáº·c cÃ¡ nhÃ¢n sá»­ dá»¥ng RoxaVN Ä‘á»ƒ â€œdá»±ng cá»­a hÃ ng, má»Ÿ dá»‹ch vá»¥â€, cung cáº¥p Ä‘á»§ thá»© cho khÃ¡ch hÃ ng.
- **KhÃ¡ch hÃ ng:** ngÆ°á»i dÃ¹ng cuá»‘i, lÃ  thÆ°á»£ng Ä‘áº¿ cá»§a báº¡n ğŸ‘‘.

### 2. Giao diá»‡n ngÆ°á»i dÃ¹ng
- **Admin dashboard:** nÆ¡i nhÃ  cung cáº¥p vÃ o â€œÄ‘iá»u hÃ nh tháº¿ giá»›iâ€ â€” quáº£n lÃ½ user, dá»‹ch vá»¥, v.v.  
   - ğŸ› ï¸ Truy cáº­p: `/admin/apps`
- **Personal profile:** chá»— khÃ¡ch hÃ ng tá»± â€œtÃºt láº¡i profileâ€, chá»‰nh tÃªn, thay avatar, Ä‘á»•i mood.  
   - ğŸ‘¤ Truy cáº­p: `/me`
- **Custom application:** náº¿u tháº¥y chÆ°a Ä‘á»§, báº¡n cÃ³ thá»ƒ â€œnáº¥u mÃ³n riÃªngâ€, phÃ¡t triá»ƒn á»©ng dá»¥ng web tÃ¹y mÃ´ hÃ¬nh kinh doanh.

### 3. ThÃ nh pháº§n backend

Há»‡ thá»‘ng cá»§a RoxaVN chia lÃ m hai â€œnhÃ¢n váº­t chÃ­nhâ€: má»™t anh â€œgiao tiáº¿p xÃ£ há»™iâ€ vÃ  má»™t anh â€œá»Ÿ háº­u trÆ°á»ng lÃ m viá»‡c quáº§n quáº­tâ€ ğŸ˜†  

#### 3.1. Web Server â€“ Anh chÃ ng nÃ³i nhiá»u  

ÄÃ¢y lÃ  máº·t tiá»n cá»§a RoxaVN, nÆ¡i xá»­ lÃ½ **RESTful API** vÃ  **WebSocket**. NÃ³i cÃ¡ch khÃ¡c, Ä‘Ã¢y lÃ  â€œngÆ°á»i phÃ¡t ngÃ´n chÃ­nh thá»©câ€ â€“  client há»i gÃ¬, anh nÃ y tráº£ lá»i; cÃ³ socket káº¿t ná»‘i, anh nÃ y chat láº¡i liá»n. KhÃ´ng cÃ³ web server thÃ¬ cáº£ há»‡ thá»‘ng im nhÆ° chÃ¹a mÃ¹a mÆ°a. ğŸ§˜â€â™‚ï¸

#### 3.2. Job Service â€“ CÃ´ng nhÃ¢n áº©n danh

PhÃ­a sau Ã¡nh Ä‘Ã¨n sÃ¢n kháº¥u, **Job Service** lÃ  ngÆ°á»i cÃ y cuá»‘c tháº§m láº·ng:  
- Cháº¡y **cronjob** Ä‘á»‹nh ká»³ (kiá»ƒu nhÆ° nháº¯c â€œÃŠ, hÃ´m nay quÃ©t dá»¯ liá»‡u chÆ°a?â€).  
- Láº¯ng nghe **event tá»« API hoáº·c database** rá»“i xá»­ lÃ½ trong im láº·ng.
- LÃ m háº¿t máº¥y viá»‡c â€œnáº·ng nhá»câ€ Ä‘á»ƒ Web Server khÃ´ng bá»‹ stress ğŸ¤¯

RoxaVN chia Job Service thÃ nh hai vai trÃ² chÃ­nh:

1. **Job Worker** lÃ  tiáº¿n trÃ¬nh thá»±c thi cÃ¡c tÃ¡c vá»¥ (job) Ä‘Æ°á»£c giao. CÃ³ thá»ƒ cháº¡y nhiá»u process song song Ä‘á»ƒ tÄƒng kháº£ nÄƒng xá»­ lÃ½. Äáº·c Ä‘iá»ƒm:
     - Má»—i worker láº¯ng nghe hÃ ng Ä‘á»£i job
     - Khi nháº­n Ä‘Æ°á»£c job, worker sáº½ xá»­ lÃ½
     - CÃ³ thá»ƒ scale theo sá»‘ lÆ°á»£ng CPU hoáº·c pod khi triá»ƒn khai trÃªn Kubernetes. 
2. **Job Dispatcher** chá»‹u trÃ¡ch nhiá»‡m táº¡o vÃ  phÃ¡t cÃ¡c job cho worker. NÃ³ chá»‰ nÃªn cháº¡y má»™t process duy nháº¥t trong há»‡ thá»‘ng. Nhiá»‡m vá»¥ chÃ­nh:
     - KÃ­ch hoáº¡t cÃ¡c job theo lá»‹ch Ä‘á»‹nh ká»³ (cron).
     - Láº¯ng nghe cÃ¡c sá»± kiá»‡n tá»« Database hoáº·c cÃ¡c service khÃ¡c.
     - Gá»­i job Ä‘áº¿n queue Ä‘á»ƒ cÃ¡c worker thá»±c hiá»‡n.

##### Trong mÃ´i trÆ°á»ng dev  

Khi báº¡n cháº¡y `npm run dev` RoxaVN sáº½ load cáº£ Web Server láº«n Job Service trong cÃ¹ng má»™t tiáº¿n trÃ¬nh. Táº¥t cáº£ cÃ¹ng sá»‘ng hÃ²a bÃ¬nh, giÃºp dev test dá»… dÃ ng hÆ¡n â€“ khÃ´ng cáº§n má»Ÿ 100 terminal. Cháº¡y 1 lá»‡nh, 2 anh lÃªn sÃ n cÃ¹ng lÃºc ğŸ­.

##### Trong mÃ´i trÆ°á»ng production

Khi deploy tháº­t, má»i thá»© nghiÃªm tÃºc hÆ¡n:

- Lá»‡nh `npm start` chá»‰ khá»Ÿi Ä‘á»™ng Web Server â€“ Ä‘á»ƒ phá»¥c vá»¥ client.
- CÃ²n Job Service Ä‘Æ°á»£c tÃ¡ch riÃªng:
    - Cháº¡y job worker `npx roxavn job -w`. CÃ³ thá»ƒ cháº¡y nhiá»u process.
    - Cháº¡y job dispatcher `npx roxavn job -d`. Chá»‰ cháº¡y 1 process Ä‘á»ƒ báº¯n cÃ¡c event theo cron, hay event tá»« database cho cÃ¡c job worker thá»±c hiá»‡n.
    - Hoáº·c cháº¡y cáº£ job worker láº«n job dispatcher `npx roxavn job`. Chá»‰ cháº¡y 1 process, thÃ­ch há»£p cho á»©ng dá»¥ng nhá», khÃ´ng cáº§n nhiá»u job worker xá»­ lÃ½. Náº¿u cháº¡y nhiá»u process, sáº½ khiáº¿n cÃ¡c cron job bá»‹ kÃ­ch hoáº¡t nhiá»u láº§n. 

Nhá» tÃ¡ch riÃªng nhÆ° váº­y, há»‡ thá»‘ng á»•n Ä‘á»‹nh, dá»… scale, vÃ  náº¿u Worker cÃ³ â€œlÄƒn ra ngá»§ quÃªnâ€, Web Server váº«n tiáº¿p tá»¥c hoáº¡t Ä‘á»™ng ngon lÃ nh ğŸ˜´.

### 4. Database

ÄÃ¢y lÃ  táº§ng dÆ°á»›i cÃ¹ng, Ä‘áº£m nháº­n lÆ°u trá»¯ dá»¯ liá»‡u vá»›i Postgres. NgoÃ i ra báº¡n cÃ³ thá»ƒ cache dá»¯ liá»‡u vá»›i Redis giÃºp tÄƒng cÆ°á»ng hiá»‡u suáº¥t cho há»‡ thá»‘ng.


## Module Structure

<pre>
test-module/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ base/             # contains shared code for both server/ and web/
â”‚   â”‚   â”œâ”€â”€ module.ts     # declares the module
â”‚   â”‚   â”œâ”€â”€ access.ts     # declares scopes, permissions, and roles
â”‚   â”‚   â”œâ”€â”€ errors.ts     # declares errors
â”‚   â”‚   â””â”€â”€ apis          # API declarations
â”‚   â”‚       â”œâ”€â”€ task.ts   # API for `task` entity
â”‚   â”‚       â””â”€â”€ group.ts  # API for `group` entity
â”‚   â”‚
|   â”œâ”€â”€ server/           # backend code
â”‚   â”‚   â”œâ”€â”€ module.ts     # backend module declaration
â”‚   â”‚   â”œâ”€â”€ migrations/   # database migration files
â”‚   â”‚   â””â”€â”€ services/     # service files that implement APIs or jobs
â”‚   â”‚
|   â”œâ”€â”€ hook/             # hook services, executed via `npx roxavn hook`
â”‚   â”‚
|   â””â”€â”€ web/                  # frontend code
â”‚       â”œâ”€â”€ admin/            # pages for admin app
â”‚       â”œâ”€â”€ me/               # pages for me app
â”‚       â”œâ”€â”€ pages/            # route declarations, <a href="https://remix.run/docs/en/1.19.3/file-conventions/routes-files">details</a>
â”‚       â”‚   â””â”€â”€ abc.tsx       # page route: http://[DEV_SERVER]/abc
â”‚       â””â”€â”€ export/           # shared components for me app
â”‚           â”œâ”€â”€ module.ts     # web module declaration
â”‚           â””â”€â”€ components/   # shared React components
|
â”œâ”€â”€ static/            # static files
â”‚   â”œâ”€â”€ locales/       # localization files
â”‚   â”‚   â”œâ”€â”€ en.json    # English language file
â”‚   â”‚   â””â”€â”€ vi.json    # Vietnamese language file
|   â”œâ”€â”€ icon.svg       # module icon
|   â”œâ”€â”€ abc.txt        # arbitrary files
|   â””â”€â”€ test/
|       â””â”€â”€ a.png      # file path: http://[DEV_SERVER]/static/test-module/test/a.png
|
â”œâ”€â”€ dist/              # for publishing the module, created via `npx roxavn build`
â”œâ”€â”€ .web/              # dev build artifacts, created via `npx roxavn sync`
â””â”€â”€ package.json
</pre>

## Code Convention

### 1. Git

RoxaVN tuÃ¢n thá»§ chuáº©n [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n trong lá»‹ch sá»­ commit.

- Má»—i commit **chá»‰ thá»±c hiá»‡n má»™t nhiá»‡m vá»¥ duy nháº¥t** (vÃ­ dá»¥: *fix bug*, *update UI*, *refactor code*).  
- Tuyá»‡t Ä‘á»‘i khÃ´ng gá»™p nhiá»u loáº¡i thay Ä‘á»•i (nhÆ° vá»«a sá»­a lá»—i, vá»«a cáº­p nháº­t giao diá»‡n) trong cÃ¹ng má»™t commit.  
- TÃªn commit pháº£i tuÃ¢n theo Ä‘á»‹nh dáº¡ng chuáº©n, vÃ­ dá»¥:

  ```
  feat(auth): add login via Google
  fix(ui): correct button alignment on mobile
  chore(deps): update eslint config
  ```

### 2. JavaScript Packages

RoxaVN chá»‰ sá»­ dá»¥ng **ES Module** nháº±m tá»‘i Æ°u hÃ³a quÃ¡ trÃ¬nh build client (Ä‘áº·c biá»‡t lÃ  há»— trá»£ **tree-shaking**).

VÃ¬ váº­y, trong file `package.json` cá»§a má»—i package cáº§n khai bÃ¡o rÃµ:

```json
{
  "type": "module"
}
```

> âš ï¸ KhÃ´ng sá»­ dá»¥ng CommonJS (`require`, `module.exports`) trong báº¥t ká»³ package nÃ o.

Khi import cÃ¡c file trong dá»± Ã¡n, báº¯t buá»™c pháº£i thÃªm Ä‘uÃ´i **`.js`** Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch vá»›i chuáº©n **ES Module**.  

VÃ­ dá»¥:

```ts
import { program } from './program.js';
```

> âš ï¸ Náº¿u thiáº¿u pháº§n má»Ÿ rá»™ng .js, quÃ¡ trÃ¬nh build hoáº·c runtime cÃ³ thá»ƒ gáº·p lá»—i ERR_MODULE_NOT_FOUND trong mÃ´i trÆ°á»ng Node.js ESM.

NgoÃ i ra trong `package.json` cá»§a má»—i module cÅ©ng pháº£i khai bÃ¡o exports cÃ¡c submodule `base`, `server`, `web`

> Khi cháº¡y `npx roxavn gen module` Ä‘Ã£ tá»± Ä‘á»™ng táº¡o cho báº¡n

```json
{
  "exports": {
    ".": {
      "types": "./dist/esm/index.d.ts",
      "default": "./dist/esm/index.js"
    },
    "./web": {
      "types": "./dist/esm/web/index.d.ts",
      "default": "./dist/esm/web/index.js"
    },
    "./base": {
      "types": "./dist/esm/base/index.d.ts",
      "default": "./dist/esm/base/index.js"
    },
    "./server": {
      "types": "./dist/esm/server/index.d.ts",
      "default": "./dist/esm/server/index.js"
    }
  },
}
```

| Submodule    | Má»¥c Ä‘Ã­ch                                                     |
| ------------ | ------------------------------------------------------------ |
| `"."`        | Export chÃ­nh cá»§a module (dÃ¹ng chung)                         |
| `"./base"`   | Chá»©a logic dÃ¹ng chung giá»¯a web & server                      |
| `"./server"` | DÃ nh cho backend (middleware, service, â€¦)                    |
| `"./web"`    | DÃ nh cho cÃ¡c thÃ nh pháº§n frontend (React hooks, component, â€¦) |

### 3. Quy táº¯c Ä‘áº·t tÃªn

| ThÃ nh pháº§n                   | Quy táº¯c Ä‘áº·t tÃªn | VÃ­ dá»¥                        |
| ---------------------------- | --------------- | ---------------------------- |
| **Class**                    | PascalCase      | `UserService`, `AuthManager` |
| **Biáº¿n / HÃ m thÃ´ng thÆ°á»ng**  | camelCase       | `userList`, `fetchData()`    |
| **React Component Function** | PascalCase      | `ApiTable`, `ApiFetcher`     |
| **Háº±ng sá»‘ (constant)**       | UPPER_CASE      | `MAX_RETRY_COUNT`, `API_URL` |

### 4. Äá»™ dÃ i mÃ£ nguá»“n

Äá»ƒ giá»¯ cho mÃ£ nguá»“n dá»… Ä‘á»c, dá»… báº£o trÃ¬ vÃ  dá»… review, cáº§n tuÃ¢n thá»§ cÃ¡c giá»›i háº¡n sau:

| Loáº¡i mÃ£ nguá»“n         | Giá»›i háº¡n khuyáº¿n nghá»‹ | Giá»›i háº¡n tá»‘i Ä‘a |
| --------------------- | -------------------- | --------------- |
| **File**              | 100 â€“ 200 dÃ²ng       | < 500 dÃ²ng      |
| **Function / Method** | 10 â€“ 50 dÃ²ng         | < 100 dÃ²ng      |

> âœ… Náº¿u má»™t file hoáº·c function vÆ°á»£t quÃ¡ giá»›i háº¡n, cáº§n xem xÃ©t **tÃ¡ch nhá»** hoáº·c **refactor** Ä‘á»ƒ tÄƒng kháº£ nÄƒng tÃ¡i sá»­ dá»¥ng vÃ  dá»… kiá»ƒm thá»­.

### 5. MÃ´i trÆ°á»ng phÃ¡t triá»ƒn

Khuyáº¿n nghá»‹ sá»­ dá»¥ng VSCode lÃ m trÃ¬nh soáº¡n tháº£o chÃ­nh Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»“ng bá»™ mÃ´i trÆ°á»ng lÃ m viá»‡c giá»¯a cÃ¡c thÃ nh viÃªn trong dá»± Ã¡n. Sau khi khá»Ÿi táº¡o dá»± Ã¡n, nÃªn cháº¡y lá»‡nh `npx roxavn gen module convention` Ä‘á»ƒ táº¡o cÃ¡c cáº¥u hÃ¬nh tiÃªu chuáº©n:

- Cáº¥u hÃ¬nh BiomeJS Ä‘á»ƒ Ä‘á»‹nh dáº¡ng vÃ  lint code (thay tháº¿ ESLint + Prettier)
- Thiáº¿t láº­p Lefthook Ä‘á»ƒ kiá»ƒm tra:
    - commit message cÃ³ tuÃ¢n theo Conventional Commits hay khÃ´ng
    - Ä‘áº£m báº£o format code vÃ  lint tá»± Ä‘á»™ng trÆ°á»›c khi commit.

> ğŸ’¡ BiomeJS giÃºp cáº£i thiá»‡n tá»‘c Ä‘á»™ lint/format Ä‘Ã¡ng ká»ƒ vÃ  giáº£m Ä‘á»™ phá»©c táº¡p trong cáº¥u hÃ¬nh.

NgoÃ i viá»‡c khá»Ÿi táº¡o convention ban Ä‘áº§u, báº¡n cÃ³ thá»ƒ cháº¡y lá»‡nh `npx roxavn gen editor vscode` Ä‘á»ƒ tá»‘i Æ°u tráº£i nghiá»‡m phÃ¡t triá»ƒn trÃªn **VSCode**. Lá»‡nh nÃ y sáº½ tá»± Ä‘á»™ng:
- Táº¡o code snippets giÃºp viáº¿t nhanh cÃ¡c Ä‘oáº¡n mÃ£ RoxaVN phá»• biáº¿n.
- Thiáº¿t láº­p cáº¥u hÃ¬nh launch cho phÃ©p debug cÃ¡c RoxaVN module.
- Cáº¥u hÃ¬nh thuá»™c tÃ­nh "importModuleSpecifierEnding" trong VSCode Ä‘á»ƒ Ä‘áº£m báº£o tá»± Ä‘á»™ng thÃªm Ä‘uÃ´i `.js` khi import module ES.

### 6. PhiÃªn báº£n vÃ  quy Æ°á»›c Ä‘áº·t version

Tá»« **phiÃªn báº£n 4 trá»Ÿ Ä‘i**, RoxaVN tuÃ¢n thá»§ chuáº©n [Semantic Versioning (SemVer)](https://semver.org/) vá»›i format `MAJOR.MINOR.PATCH`


| ThÃ nh pháº§n | Ã nghÄ©a                                                         | VÃ­ dá»¥ thay Ä‘á»•i |
| ---------- | --------------------------------------------------------------- | -------------- |
| **MAJOR**  | Thay Ä‘á»•i lá»›n, cÃ³ thá»ƒ phÃ¡ vá»¡ tÆ°Æ¡ng thÃ­ch (breaking changes).     | 4.x.x â†’ 5.0.0  |
| **MINOR**  | ThÃªm tÃ­nh nÄƒng má»›i, **tÆ°Æ¡ng thÃ­ch ngÆ°á»£c**.                      | 4.1.0 â†’ 4.2.0  |
| **PATCH**  | Sá»­a lá»—i, tá»‘i Æ°u hoáº·c thay Ä‘á»•i nhá», **khÃ´ng áº£nh hÆ°á»Ÿng** Ä‘áº¿n API. | 4.2.0 â†’ 4.2.1  |

- Má»i module trong há»‡ sinh thÃ¡i RoxaVN Ä‘á»u Ä‘á»“ng bá»™ theo cÃ¹ng version gá»‘c cá»§a framework.
- Khi cáº­p nháº­t phiÃªn báº£n **MAJOR**, báº¡n nÃªn kiá»ƒm tra láº¡i cÃ¡c API Ä‘á»ƒ Ä‘áº£m báº£o tÆ°Æ¡ng thÃ­ch.
